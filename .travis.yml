sudo: required
dist: trusty

services:
  - docker

language: cpp

# Compiler selection
compiler:
  - gcc

before_install:
  - wget --no-check-certificate https://ecsft.cern.ch/dist/cvmfs/cvmfs-release/cvmfs-release-latest_all.deb
  - sudo dpkg -i cvmfs-release-latest_all.deb
  - sudo apt-get update
  - sudo apt-get install cvmfs cvmfs-config-default
  - rm -f cvmfs-release-latest_all.deb
  - sudo mkdir -p /etc/cvmfs
  - sudo mkdir -p /etc/cvmfs/domain.d
  - sudo mkdir -p /etc/cvmfs/keys/desy.de
  - touch default.local
  - echo "CVMFS_REPOSITORIES=ilc.desy.de" >> default.local
  - echo "CVMFS_CACHE_BASE=/var/cache/cvmfs2" >> default.local
  - echo "CVMFS_QUOTA_LIMIT=24900" >> default.local
  - echo "CVMFS_HTTP_PROXY="http://batch-squid.desy.de:3128;DIRECT"" >> default.local
  - echo "CVMFS_SERVER_URL="http://grid-cvmfs-one.desy.de/cvmfs/@fqrn@;http://cvmfs-stratum-one.cern.ch/opt/@org@;http://cernvmfs.gridpp.rl.ac.uk/opt/@org@;http://cvmfs.racf.bnl.gov/opt/@org@;http://cvmfs.fnal.gov/opt/@org@;http://cvmfs-stratum-one.hep.pnnl.gov/cvmfs/@fqrn@"" >> default.local
  - echo "CVMFS_NFS_SOURCE=no" >> default.local
  - echo "CVMFS_MEMCACHE_SIZE=64" >> default.local
  - echo "CVMFS_NFILES=65535" >> default.local
  - touch desy.de.conf
  - echo "CVMFS_SERVER_URL="http://grid-cvmfs-one.desy.de:8000/cvmfs/@fqrn@"" >> desy.de.conf
  - echo "CVMFS_KEYS_DIR=/etc/cvmfs/keys/desy.de" >> desy.de.conf
  - echo "CVMFS_USE_GEOAPI=no" >> desy.de.conf
  - sudo mv default.local /etc/cvmfs/
  - sudo mv desy.de.conf  /etc/cvmfs/domain.d/desy.de.conf
  - wget http://grid.desy.de/etc/cvmfs/keys/desy.de.pub
  - sudo mv desy.de.pub /etc/cvmfs/keys/desy.de/desy.de.pub
  - sudo /etc/init.d/autofs stop
  - sudo cvmfs_config setup
  - sudo mkdir -p /cvmfs/ilc.desy.de
  - sudo mount -t cvmfs ilc.desy.de /cvmfs/ilc.desy.de
  - ls /cvmfs/ilc.desy.de

# command to install dependencies
install:
  - echo ${PWD}
  - export PKGDIR=${PWD}

# command to run tests
script:
  - docker run -it --name CI_container -v $PKGDIR:/Package -e COMPILER=gcc -v /cvmfs/ilc.desy.de:/cvmfs/ilc.desy.de -d clicdp/slc6-build /bin/bash
  - docker exec -it CI_container /bin/bash -c "./Package/.travis-ci.d/build.sh";
